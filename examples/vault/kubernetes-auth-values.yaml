# Example: Vault Integration with Kubernetes Auth
# This example shows how to configure the argo-stack chart to use
# HashiCorp Vault for secret management with Kubernetes authentication.

# Enable External Secrets integration
externalSecrets:
  enabled: true
  
  # Install ESO as part of this chart
  # Set to false if ESO is already installed cluster-wide
  installOperator: true
  
  # ESO subchart configuration
  external-secrets:
    installCRDs: true
    namespaceOverride: ""
  
  # Vault provider configuration
  vault:
    enabled: true
    
    # Vault server address
    # For local Kind cluster with Vault in Docker: http://host.docker.internal:8200
    # For Vault in same cluster: http://vault.vault.svc.cluster.local:8200
    address: "http://vault.vault.svc.cluster.local:8200"
    
    # Optional: CA bundle for TLS verification (production)
    # caBundleSecretName: "vault-ca-bundle"
    # caBundleSecretKey: "ca.crt"
    
    # Kubernetes authentication (recommended for prod)
    auth:
      method: "kubernetes"
      mount: "kubernetes"  # Auth method mount path in Vault
      role: "argo-stack"   # Vault role name
      serviceAccountName: "eso-vault-auth"  # K8s ServiceAccount for ESO
    
    # KV secrets engine configuration
    kv:
      engineVersion: 2  # KV v2 supports versioning
      defaultPathPrefix: "kv/argo"  # All paths are relative to this
    
    # Use namespaced SecretStore (recommended)
    scope: "namespaced"
    namespace: "argocd"
  
  # Secret path mappings
  secrets:
    # Argo CD secrets
    argocd:
      adminPasswordPath: "argocd/admin#password"
      adminPasswordBcryptPath: "argocd/admin#bcryptHash"
      ssoClientSecretPath: "argocd/oidc#clientSecret"
      serverSecretKeyPath: "argocd/server#secretKey"
    
    # Argo Workflows secrets
    workflows:
      artifactAccessKeyPath: "workflows/artifacts#accessKey"
      artifactSecretKeyPath: "workflows/artifacts#secretKey"
      ssoClientSecretPath: "workflows/oidc#clientSecret"
    
    # Authorization adapter secrets
    authzAdapter:
      oidcClientSecretPath: "authz#clientSecret"
    
    # GitHub Events secrets
    github:
      tokenPath: "events/github#token"
    
    # Per-application S3 credentials (optional)
    perAppS3:
      nextflow-hello:
        accessKeyPath: "apps/nextflow-hello/s3#accessKey"
        secretKeyPath: "apps/nextflow-hello/s3#secretKey"
      nextflow-hello-2:
        accessKeyPath: "apps/nextflow-hello-2/s3#accessKey"
        secretKeyPath: "apps/nextflow-hello-2/s3#secretKey"

# S3 artifact storage configuration
# When ESO is enabled, credentials come from Vault
s3:
  enabled: true
  hostname: "s3.amazonaws.com"
  bucket: "my-argo-artifacts"
  region: "us-west-2"
  insecure: false
  pathStyle: false
  # accessKey and secretKey are NOT needed when using Vault
  # They will be synced from Vault paths defined above

# Argo Events configuration
events:
  enabled: true
  github:
    enabled: true
    secret:
      create: true  # ExternalSecret will be created
      name: "github-secret"
      tokenKey: "token"
      # tokenValue is NOT needed when using Vault
      # It will be synced from Vault path defined above

# Keep all other settings as per your requirements
namespaces:
  argo: argo-workflows
  argocd: argocd
  tenant: wf-poc
  security: security
  argo-events: argo-events

argo-cd:
  enabled: true
  namespaceOverride: argocd

argo-workflows:
  server:
    enabled: true
    secure: false
  namespaceOverride: argo-workflows

authzAdapter:
  enabled: true
  image: ghcr.io/calypr/argo-helm:latest
  fenceBase: "https://calypr-dev.ohsu.edu/user"
  replicas: 2
