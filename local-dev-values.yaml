# Local Development Values with MinIO
#
# This values file is designed for local development and testing
# using the MinIO instance started with docker-compose.
#
# Usage:
#   1. Start MinIO: ./dev-minio.sh start
#   2. Deploy: helm upgrade --install argo-stack ./helm/argo-stack \
#              --namespace argocd --create-namespace \
#              --values local-dev-values.yaml
#
# For production deployments, create your own values file with
# real credentials and repository configurations.

# ============================================================================
# Namespace Configuration
# ============================================================================
namespaces:
  argo: argo-workflows
  argocd: argocd
  tenant: wf-poc
  security: security
  argo-events: argo-events

# ============================================================================
# Argo Workflows Configuration
# ============================================================================
argo-workflows:
  server:
    enabled: true
    secure: false
    namespaced: true
    extraArgs:
      - --auth-mode=server
  controller:
    workflowNamespaces:
      - wf-poc
    namespaceInstallMode: true
    # Enable log archiving for all workflows
    workflowDefaults:
      spec:
        archiveLogs: true
  namespaceOverride: argo-workflows

# ============================================================================
# Argo CD Configuration
# ============================================================================
argo-cd:
  applications:
    enabled: true
    namespace: argocd
  namespaceOverride: argocd
  configs:
    secret:
      create: true
      extra: {}
      # Generate a secret key:
      # export ARGOCD_SECRET_KEY=$(openssl rand -hex 32)
      # Then set: --set-string argo-cd.configs.secret.extra."server\.secretkey"="${ARGOCD_SECRET_KEY}"

# ============================================================================
# Authorization Adapter (Minimal for Dev)
# ============================================================================
authzAdapter:
  image: ghcr.io/calypr/argo-helm:latest
  fenceBase: "https://calypr-dev.ohsu.edu/user"
  replicas: 1  # Single replica for dev
  namespace: security

# ============================================================================
# Local MinIO S3 Storage (Development Only)
# ============================================================================
# These settings connect to the MinIO instance from docker-compose.yml
# 
# ⚠️  WARNING: These are development credentials only!
#     DO NOT use these settings in production environments.
s3:
  enabled: true
  hostname: "localhost:9000"           # MinIO S3 API endpoint
  bucket: "argo-artifacts-dev"         # Default bucket for workflows
  region: "us-east-1"                  # MinIO default region
  insecure: true                       # HTTP (not HTTPS)
  pathStyle: true                      # Required for MinIO
  accessKey: "minioadmin"              # MinIO default access key
  secretKey: "minioadmin"              # MinIO default secret key

# ============================================================================
# Ingress Configuration (Local Development)
# ============================================================================
ingress:
  argoWorkflows:
    enabled: false  # Use port-forward for local dev
    host: "argo.localtest.me"
    tls:
      enabled: false
  argocd:
    enabled: false  # Use port-forward for local dev
    host: "argocd.localtest.me"
    tls:
      enabled: false

ingressAuth:
  enabled: false  # Disable auth for local dev

# ============================================================================
# Applications Configuration
# ============================================================================
# In development, you typically don't want to specify applications in the
# chart values. Instead, provide them as overrides or in a separate file.
#
# Example applications are commented out below. Uncomment and modify
# with your own repository URLs and configurations.
#
# For production, NEVER include repository URLs in committed values files.
# Always provide them at deployment time via:
#   --values my-repos.yaml
# or:
#   --set applications[0].repoURL=https://github.com/org/repo.git

applications: []
  # - name: my-test-workflow
  #   repoURL: https://github.com/YOUR_ORG/YOUR_REPO.git
  #   targetRevision: main
  #   path: "."
  #   destination:
  #     namespace: wf-poc
  #   syncPolicy:
  #     automated:
  #       prune: true
  #       selfHeal: true
  #   # Optional: Per-repository MinIO bucket
  #   artifacts:
  #     bucket: calypr-nextflow-hello
  #     endpoint: http://localhost:9000
  #     region: us-east-1
  #     insecure: true
  #     pathStyle: true
  #     # For dev, you can use the same credentials as global s3
  #     # Or create a specific secret:
  #     # kubectl create secret generic minio-creds -n wf-poc \
  #     #   --from-literal=accessKey=minioadmin \
  #     #   --from-literal=secretKey=minioadmin
  #     credentialsSecret: minio-creds

# ============================================================================
# Argo Events Configuration (Disabled for Local Dev)
# ============================================================================
# Events are typically not needed for basic local testing.
# Enable and configure if you need to test GitHub webhooks locally.
events:
  enabled: false
  namespace: argo-events
  eventBus:
    create: true
    name: default
    natsNative: {}
  github:
    enabled: false
    name: github
    repositories: []
    secret:
      create: false
    webhook:
      endpoint: /events
      port: 12000
      service:
        type: ClusterIP
      ingress:
        enabled: false
  sensor:
    enabled: false

# ============================================================================
# Workflow Templates (Example)
# ============================================================================
workflowTemplates:
  createExample: true
  namespace: wf-poc
  nextflowHello:
    name: nextflow-hello-template
    image: alpine:3.20
    command: ["/bin/sh", "-c"]
    args:
      - echo "Hello from Argo Workflows with MinIO storage!"

workflows:
  namespace: wf-poc
  runnerServiceAccount: wf-runner
  templateRef: nextflow-hello-template

# ============================================================================
# Quick Start Guide
# ============================================================================
# 
# 1. Start MinIO:
#    ./dev-minio.sh start
# 
# 2. Create a Kind cluster (optional):
#    kind create cluster
# 
# 3. Install the chart:
#    helm repo add argo https://argoproj.github.io/argo-helm
#    helm repo update
#    helm dependency build helm/argo-stack
#    
#    export ARGOCD_SECRET_KEY=$(openssl rand -hex 32)
#    
#    helm upgrade --install argo-stack ./helm/argo-stack \
#      --namespace argocd --create-namespace \
#      --values local-dev-values.yaml \
#      --set-string argo-cd.configs.secret.extra."server\.secretkey"="${ARGOCD_SECRET_KEY}" \
#      --wait --timeout 10m
# 
# 4. Port-forward to access UIs:
#    kubectl -n argo-workflows port-forward svc/argo-stack-argo-workflows-server 2746:2746 &
#    kubectl -n argocd port-forward svc/argo-stack-argocd-server 8080:443 &
# 
# 5. Access the services:
#    - Argo Workflows: http://localhost:2746
#    - Argo CD:        http://localhost:8080
#    - MinIO Console:  http://localhost:9001 (minioadmin/minioadmin)
# 
# 6. Get ArgoCD password:
#    kubectl -n argocd get secret argocd-initial-admin-secret \
#      -o jsonpath="{.data.password}" | base64 -d && echo
# 
# 7. Test workflow with artifact storage:
#    argo -n wf-poc submit --from workflowtemplate/nextflow-hello-template
#    
#    # Check artifacts in MinIO:
#    Open http://localhost:9001 and browse to argo-artifacts-dev bucket
