{{- /*
Per-Application Artifact Repositories
Renders a ConfigMap for each application that has an artifacts configuration.
This enables per-repository S3 buckets and credentials for workflow outputs.
*/ -}}
{{- range .Values.applications }}
{{- if .artifacts }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argo-artifacts-{{ .name }}
  namespace: {{ $.Values.namespaces.argo }}
  labels:
    app.kubernetes.io/name: argo-workflows
    app.kubernetes.io/part-of: argo-stack
    app.kubernetes.io/component: artifact-repository
    app.kubernetes.io/managed-by: helm
    calypr.io/application: {{ .name }}
data:
  artifactRepository: |
    archiveLogs: true
    s3:
      bucket: {{ .artifacts.bucket }}
      {{- if .artifacts.keyPrefix }}
      keyPrefix: {{ .artifacts.keyPrefix }}
      {{- end }}
      {{- if .artifacts.endpoint }}
      endpoint: {{ .artifacts.endpoint }}
      {{- end }}
      {{- if .artifacts.region }}
      region: {{ .artifacts.region }}
      {{- end }}
      insecure: {{ .artifacts.insecure | default false }}
      {{- if .artifacts.useSDKCreds }}
      useSDKCreds: {{ .artifacts.useSDKCreds }}
      {{- else if .artifacts.credentialsSecret }}
      accessKeySecret:
        name: {{ .artifacts.credentialsSecret }}
        key: {{ .artifacts.accessKeyKey | default "accessKey" }}
      secretKeySecret:
        name: {{ .artifacts.credentialsSecret }}
        key: {{ .artifacts.secretKeyKey | default "secretKey" }}
      useSDKCreds: false
      {{- end }}
      {{- if .artifacts.pathStyle }}
      pathStyle: {{ .artifacts.pathStyle }}
      {{- end }}
{{- end }}
{{- end }}
