{{- if and .Values.githubApp.enabled .Values.externalSecrets.enabled }}
{{- if .Values.githubApp.privateKey.externalSecrets.enabled }}
{{- if not .Values.githubApp.privateKey.existingSecretName }}
{{- $secretPath := .Values.githubApp.privateKey.externalSecrets.path | default "argo/argocd/github-app" }}
{{- $secretName := .Values.githubApp.repoCreds.secretName | default "argocd-github-app-repo-creds" }}
---
# ExternalSecret for GitHub App credentials
# Fetches GitHub App ID, Installation ID, and Private Key from Vault
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Values.namespaces.argocd | default "argocd" }}
  labels:
    app.kubernetes.io/name: github-app-credentials
    app.kubernetes.io/part-of: argo-stack
    app.kubernetes.io/component: argocd
    secret-type: github-app
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "5"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  secretStoreRef:
    name: {{ .Values.externalSecrets.vault.secretStoreName | default "argo-stack-vault" }}
    kind: {{ ternary "ClusterSecretStore" "SecretStore" (eq .Values.externalSecrets.vault.scope "cluster") }}
  target:
    name: {{ $secretName }}
    creationPolicy: Owner
    template:
      engineVersion: v2
      metadata:
        labels:
          app.kubernetes.io/name: github-app-credentials
          app.kubernetes.io/part-of: argo-stack
          argocd.argoproj.io/secret-type: repo-creds
      data:
        # Repository URL prefix for credential matching
        url: {{ .Values.githubApp.repoCreds.url | quote }}
        # Git repository type
        type: "git"
        # GitHub App ID
        githubAppID: "{{ `{{ .appId }}` }}"
        # GitHub App Installation ID
        githubAppInstallationID: "{{ `{{ .installationId }}` }}"
        # GitHub App Private Key (PEM format)
        githubAppPrivateKey: "{{ `{{ .privateKey }}` }}"
  data:
    - secretKey: appId
      remoteRef:
        key: {{ printf "%s/%s" (.Values.externalSecrets.vault.kv.defaultPathPrefix | default "kv") $secretPath }}
        property: appId
    - secretKey: installationId
      remoteRef:
        key: {{ printf "%s/%s" (.Values.externalSecrets.vault.kv.defaultPathPrefix | default "kv") $secretPath }}
        property: installationId
    - secretKey: privateKey
      remoteRef:
        key: {{ printf "%s/%s" (.Values.externalSecrets.vault.kv.defaultPathPrefix | default "kv") $secretPath }}
        property: privateKey
{{- end }}
{{- end }}
{{- end }}
