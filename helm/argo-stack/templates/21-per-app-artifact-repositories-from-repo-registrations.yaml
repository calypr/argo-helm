{{- /*
Per-Application Artifact Repositories from RepoRegistrations
Renders a ConfigMap for each RepoRegistration that has artifactBucket configuration.
This enables per-repository S3 buckets and credentials for workflow outputs.
*/ -}}
{{- range .Values.repoRegistrations }}
{{- if .artifactBucket }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argo-artifacts-{{ .name }}
  namespace: {{ $.Values.namespaces.argo }}
  labels:
    app.kubernetes.io/name: argo-workflows
    app.kubernetes.io/part-of: argo-stack
    app.kubernetes.io/component: artifact-repository
    app.kubernetes.io/managed-by: helm
    calypr.io/application: {{ .name }}
    {{- if .tenant }}
    tenant: {{ .tenant }}
    {{- end }}
    source: repo-registration
  annotations:
    repo-registration/name: {{ .name | quote }}
    repo-registration/repo-url: {{ .repoUrl | quote }}
data:
  artifactRepository: |
    archiveLogs: true
    s3:
      bucket: {{ .artifactBucket.bucket }}
      {{- if .artifactBucket.keyPrefix }}
      keyPrefix: {{ .artifactBucket.keyPrefix }}
      {{- else }}
      keyPrefix: "workflows/"
      {{- end }}
      {{- if .artifactBucket.hostname }}
      endpoint: {{ .artifactBucket.hostname }}
      {{- end }}
      {{- if .artifactBucket.region }}
      region: {{ .artifactBucket.region }}
      {{- end }}
      insecure: {{ .artifactBucket.insecure | default false }}
      {{- if .artifactBucket.useSDKCreds }}
      useSDKCreds: {{ .artifactBucket.useSDKCreds }}
      {{- else }}
      accessKeySecret:
        name: s3-cred-{{ .name }}
        key: AWS_ACCESS_KEY_ID
      secretKeySecret:
        name: s3-cred-{{ .name }}
        key: AWS_SECRET_ACCESS_KEY
      useSDKCreds: false
      {{- end }}
      {{- if .artifactBucket.pathStyle }}
      pathStyle: {{ .artifactBucket.pathStyle }}
      {{- end }}
{{- end }}
{{- end }}
