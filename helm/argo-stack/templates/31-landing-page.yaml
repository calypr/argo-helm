{{- if .Values.landingPage.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: landing-page-html
  namespace: {{ .Values.namespaces.security }}
  labels:
    app: landing-page
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{{ .Values.landingPage.title | default "Welcome" }}</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                line-height: 1.6;
                max-width: 800px;
                margin: 0 auto;
                padding: 2rem;
                color: #333;
            }
            #content { background: #fff; }
            .error {
                color: #d32f2f;
                padding: 1rem;
                border: 1px solid #d32f2f;
                border-radius: 4px;
                background: #ffebee;
            }
            a { color: #1976d2; }
            code { background: #f5f5f5; padding: 0.2em 0.4em; border-radius: 3px; }
            pre { background: #f5f5f5; padding: 1rem; overflow-x: auto; border-radius: 4px; }
            pre code { background: none; padding: 0; }
            img { max-width: 100%; }
        </style>
    </head>
    <body>
        <div id="content">Loading...</div>
        <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
        <script>
            const files = ['index.md', 'README.md'];
            async function loadMarkdown() {
                const content = document.getElementById('content');
                for (const file of files) {
                    try {
                        const response = await fetch('/docs/' + file);
                        if (response.ok) {
                            const text = await response.text();
                            const html = marked.parse(text);
                            content.innerHTML = DOMPurify.sanitize(html);
                            return;
                        }
                    } catch (e) { /* Try next file */ }
                }
                content.innerHTML = '<div class="error">No content available. Please add an index.md or README.md file to the docs directory.</div>';
            }
            loadMarkdown();
        </script>
    </body>
    </html>
  nginx.conf: |
    server {
        listen 80;
        server_name localhost;
        root /usr/share/nginx/html;
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options DENY;
        location / {
            try_files $uri $uri/ /index.html;
        }
        location /docs/ {
            alias /docs/;
            autoindex off;
            location ~ \.(md|png|jpg|jpeg|gif|svg)$ {
                add_header X-Content-Type-Options nosniff;
            }
        }
        location /healthz {
            access_log off;
            return 200 'ok';
            add_header Content-Type text/plain;
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: landing-page
  namespace: {{ .Values.namespaces.security }}
  labels:
    app: landing-page
spec:
  replicas: 1
  selector:
    matchLabels:
      app: landing-page
  template:
    metadata:
      labels:
        app: landing-page
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html/index.html
          subPath: index.html
        - name: nginx-conf
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: nginx.conf
        {{- if .Values.landingPage.docsPath }}
        - name: docs
          mountPath: /docs
          readOnly: true
        {{- end }}
        livenessProbe:
          httpGet:
            path: /healthz
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /healthz
            port: 80
          initialDelaySeconds: 2
          periodSeconds: 5
      volumes:
      - name: html
        configMap:
          name: landing-page-html
          items:
          - key: index.html
            path: index.html
      - name: nginx-conf
        configMap:
          name: landing-page-html
          items:
          - key: nginx.conf
            path: nginx.conf
      {{- if .Values.landingPage.docsPath }}
      # Note: hostPath is used per design requirements to allow host-mounted content.
      # Ensure the path only exposes the intended documentation directory.
      - name: docs
        hostPath:
          path: {{ .Values.landingPage.docsPath }}
          type: Directory
      {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: landing-page
  namespace: {{ .Values.namespaces.security }}
  labels:
    app: landing-page
spec:
  selector:
    app: landing-page
  ports:
  - port: 80
    targetPort: 80
{{- end }}
