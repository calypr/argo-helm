{{- /*
ClusterWorkflowTemplate for GitHub Status Notifications
Provides a centralized notification mechanism for workflows across all namespaces.
See ADR 0003 for design rationale.
*/ -}}
{{- $baseUrl := "" }}
{{- if and $.Values.workflows $.Values.workflows.baseUrl }}
{{- $baseUrl = $.Values.workflows.baseUrl }}
{{- end }}
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: github-status-notify
  labels:
    app.kubernetes.io/name: argo-stack
    app.kubernetes.io/part-of: argo-workflows
    app.kubernetes.io/component: notifications
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "10"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  templates:
    - name: notify-github-status
      # Reference workflow status/metadata directly so Argo resolves the values
      # at exit-handler execution time instead of submission time. See Argo's
      # templateRef guidance: https://argo-workflows.readthedocs.io/en/stable/workflow-templates/#referencing-other-templates
      http:
        url: http://github-status-proxy.{{ $.Values.namespaces.argocd }}.svc.cluster.local/workflow
        method: POST
        headers:
          - name: Content-Type
            value: "application/json"
        body: |
          {
            "kind": "workflow",
            "event": "workflow-{{`{{workflow.status.phase}}`}}",
            "workflowName": "{{`{{workflow.name}}`}}",
            "namespace": "{{`{{workflow.namespace}}`}}",
            "phase": "{{`{{workflow.status.phase}}`}}",
            "labels": {{`{{toJson workflow.labels}}`}},
            "annotations": {{`{{toJson workflow.annotations}}`}},
            "status": {{`{{toJson workflow.status}}`}},
            {{- if $baseUrl }}
            "target_url": "{{ printf "%s/workflows/%s/%s" $baseUrl "{{workflow.namespace}}" "{{workflow.name}}" }}"
            {{- else }}
            "target_url": ""
            {{- end }}
          }

