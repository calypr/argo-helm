{{- /*
ClusterWorkflowTemplate for GitHub Status Notifications
Provides a centralized notification mechanism for workflows across all namespaces.
See ADR 0003 for design rationale.
*/ -}}
{{- $baseUrl := "" }}
{{- if and $.Values.workflows $.Values.workflows.baseUrl }}
{{- $baseUrl = $.Values.workflows.baseUrl }}
{{- end }}
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: github-status-notify
  labels:
    app.kubernetes.io/name: argo-stack
    app.kubernetes.io/part-of: argo-workflows
    app.kubernetes.io/component: notifications
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "10"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  templates:
    - name: notify-github-status
      # Accept workflow context via parameters because templateRef does not implicitly
      # inherit caller variables. See Argo's templateRef guidance:
      # https://argo-workflows.readthedocs.io/en/stable/workflow-templates/#referencing-other-templates
      inputs:
        parameters:
          - name: workflow-name
          - name: workflow-namespace
          - name: workflow-phase
          - name: workflow-labels
          - name: workflow-annotations
          - name: workflow-status
      http:
        url: http://github-status-proxy.{{ $.Values.namespaces.argocd }}.svc.cluster.local/workflow
        method: POST
        headers:
          - name: Content-Type
            value: "application/json"
        body: |
          {
            "kind": "workflow",
            "event": "workflow-{{`{{inputs.parameters.workflow-phase}}`}}",
            "workflowName": "{{`{{inputs.parameters.workflow-name}}`}}",
            "namespace": "{{`{{inputs.parameters.workflow-namespace}}`}}",
            "phase": "{{`{{inputs.parameters.workflow-phase}}`}}",
            "labels": {{`{{inputs.parameters.workflow-labels}}`}},
            "annotations": {{`{{inputs.parameters.workflow-annotations}}`}},
            "status": {{`{{inputs.parameters.workflow-status}}`}},
            {{- if $baseUrl }}
            "target_url": "{{ printf "%s/workflows/%s/%s" $baseUrl "{{inputs.parameters.workflow-namespace}}" "{{inputs.parameters.workflow-name}}" }}"
            {{- else }}
            "target_url": ""
            {{- end }}
          }

