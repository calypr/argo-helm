{{- /*
ClusterWorkflowTemplate for GitHub Status Notifications
Provides a centralized notification mechanism for workflows across all namespaces.
See ADR 0003 for design rationale.
*/ -}}
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: github-status-notify
  labels:
    app.kubernetes.io/name: argo-stack
    app.kubernetes.io/part-of: argo-workflows
    app.kubernetes.io/component: notifications
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "10"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  templates:
    - name: notify-github-status
      # Inputs are explicitly enumerated so that caller workflows can pass
      # their metadata/status when invoking this ClusterWorkflowTemplate via
      # templateRef. Argo requires parameters to be provided by the caller; they
      # cannot be resolved from the callee's context. See Argo docs:
      # https://argo-workflows.readthedocs.io/en/stable/workflow-templates/#referencing-other-templates
      inputs:
        parameters:
          - name: workflow-name
          - name: workflow-namespace
          - name: workflow-phase
          - name: workflow-labels
          - name: workflow-annotations
          - name: workflow-status
          - name: target-url
      http:
        url: http://github-status-proxy.{{ .Values.namespaces.argocd }}.svc.cluster.local/workflow
        method: POST
        headers:
          - name: Content-Type
            value: "application/json"
        body: |
          {
            "kind": "workflow",
            "event": "workflow-{{`{{inputs.parameters.workflow-phase}}`}}",
            "workflowName": "{{`{{inputs.parameters.workflow-name}}`}}",
            "namespace": "{{`{{inputs.parameters.workflow-namespace}}`}}",
            "phase": "{{`{{inputs.parameters.workflow-phase}}`}}",
            "labels": {{`{{inputs.parameters.workflow-labels}}`}},
            "annotations": {{`{{inputs.parameters.workflow-annotations}}`}},
            "status": {{`{{inputs.parameters.workflow-status}}`}},
            "target_url": "{{`{{inputs.parameters.target-url}}`}}"
          }

