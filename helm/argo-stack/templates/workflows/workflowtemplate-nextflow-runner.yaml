apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: nextflow-runner
  namespace: {{ .Values.namespaces.tenant }}
  labels:
    app.kubernetes.io/name: nextflow-runner
    app.kubernetes.io/component: workflow
    app.kubernetes.io/part-of: argo-stack
   app.kubernetes.io/version: "1.0.0"
spec:
  artifactRepositoryRef:
    configMap: artifact-repositories
    key: default-v1
  entrypoint: run
  arguments:
    parameters:
      - name: pipeline
        value: "./"                  # or a remote repo
      - name: params
        value: ""                    # e.g., --reads 's3://bucket/*.fastq.gz'
      - name: use_k8s
        value: "true"                # set to "false" to test local executor
      - name: aws_region
        value: "us-east-1"           # AWS region for S3
      - name: nf_workdir
        value: ""                    # S3 work directory (e.g., s3://bucket/work)
  templates:
    - name: run
      serviceAccountName: nextflow-launcher
      container:
        # Custom image with Nextflow and dependencies pre-installed
        # See nextflow-runner/Dockerfile for build instructions
        image: nextflow-runner:latest
        imagePullPolicy: IfNotPresent
        workingDir: /workspace
        command: ["/bin/bash","-lc"]
        args:
          - |
            set -euxo pipefail
            mkdir -p /workspace

            # Mount cluster k8s profile if present; ignore if missing
            cp /config/nextflow.config ./nextflow.config || true

            # If pipeline=./, write a tiny pipeline WITHOUT heredocs
            if [ "{{workflow.parameters.pipeline}}" = "./" ]; then
              cat > main.nf <<'EOF'
nextflow.enable.dsl=2

process HELLO {
  output: path 'hello.txt'
  """
  echo "hello nextflow (no heredoc)" > hello.txt
  """
}

workflow { HELLO() }
EOF
              PIPE="./"
            else
              PIPE="-r {{workflow.parameters.pipeline}}"
            fi

            # Choose executor/profile
            if [ "{{workflow.parameters.use_k8s}}" = "true" ]; then
              PROFILE="-profile k8s"
            else
              PROFILE=""
            fi

            # Work directory (S3 if provided; else local)
            NF_WORKDIR_PARAM="{{workflow.parameters.nf_workdir}}"
            if [ -n "$NF_WORKDIR_PARAM" ]; then
              WARG="-w $NF_WORKDIR_PARAM"
            else
              echo "NF_WORKDIR parameter empty; using local /workspace/work"
              mkdir -p /workspace/work
              WARG="-w /workspace/work"
            fi

            export NXF_HOME="/workspace/.nxf"
            export NXF_VER=${NXF_VER:-"23.10.1"}
            export NXF_ANSI_LOG=false
            
            # Set AWS credentials from mounted secret files
            if [ -f /secrets/s3/AWS_ACCESS_KEY_ID ]; then
              export AWS_ACCESS_KEY_ID="$(cat /secrets/s3/AWS_ACCESS_KEY_ID)"
            fi
            if [ -f /secrets/s3/AWS_SECRET_ACCESS_KEY ]; then
              export AWS_SECRET_ACCESS_KEY="$(cat /secrets/s3/AWS_SECRET_ACCESS_KEY)"
            fi
            # Set AWS region from parameter
            export AWS_REGION="{{workflow.parameters.aws_region}}"

            echo "== running =="
            set +x
            echo "nextflow run $PIPE $PROFILE $WARG {{workflow.parameters.params}} -with-report report.html -with-timeline timeline.html -with-trace trace.txt"
            set -x
            nextflow run $PIPE $PROFILE $WARG {{workflow.parameters.params}}               -with-report report.html -with-timeline timeline.html -with-trace trace.txt
      volumeMounts:
        - name: cfg
          mountPath: /config
        - name: s3-credentials
          mountPath: /secrets/s3
          readOnly: true
      volumes:
        - name: cfg
          configMap:
            name: {{ .Values.configMapName | default "nextflow-config" }}
        - name: s3-credentials
          secret:
            secretName: s3-credentials
            optional: false
      outputs:
        artifacts:
          - name: report
            path: /workspace/report.html
          - name: timeline
            path: /workspace/timeline.html
          - name: trace
            path: /workspace/trace.txt
