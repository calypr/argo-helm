{{- /*
Per-Tenant Workflow Templates
Renders a WorkflowTemplate for each repoRegistration in its dedicated tenant namespace.
This ensures workflows can reference templates within the same namespace.
*/ -}}
{{- if .Values.repoRegistrations }}
{{- range $reg := .Values.repoRegistrations }}
{{- $namespace := include "argo-stack.repoRegistration.namespace" $reg }}
{{- $repoName := $reg.name }}
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: nextflow-repo-runner
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/name: argo-stack
    app.kubernetes.io/part-of: argo-workflows
    calypr.io/workflow-tenant: "true"
    calypr.io/repo: {{ $repoName }}
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "15"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  entrypoint: run-nextflow
  arguments:
    parameters:
      - name: repo-name
        description: "Repository name or identifier for accessing repo-specific secrets."
        value: {{ $repoName | quote }}
      - name: repo-url
        description: "Git repo containing the Nextflow pipeline."
        value: {{ $reg.repoUrl | quote }}
      - name: revision
        description: "Git revision (branch, tag, or SHA) to run. If git-ref is provided, it takes precedence."
        value: {{ $reg.defaultBranch | default "main" | quote }}
      - name: commit-sha
        description: "Git commit SHA that the workflow is executing. If set, takes precedence over git-ref and revision."
        value: "{{`{{workflow.parameters.git-after}}`}}"
      - name: pipeline-file
        description: "Nextflow pipeline entry point file (e.g., main.nf, workflow.nf, pipeline.nf)."
        value: "pipelines/push/main.nf"
      - name: work-dir
        description: "Work directory inside the container."
        value: "/workspace"
      - name: artifact-bucket
        description: "Artifact bucket name (from RepoRegistration.spec.artifactBucket.bucket)."
        {{- if $reg.artifactBucket }}
        value: {{ $reg.artifactBucket.bucket | quote }}
        {{- end }}
      - name: artifact-endpoint
        description: "Artifact S3 endpoint hostname/URL."
        {{- if $reg.artifactBucket }}
        value: {{ $reg.artifactBucket.hostname | quote }}
        {{- end }}
      - name: artifact-region
        description: "Artifact S3 region."
        {{- if $reg.artifactBucket }}
        value: {{ $reg.artifactBucket.region | quote }}
        {{- end }}
      - name: installation-id
        description: "GitHub App installation ID from webhook (installation.id)."
        value: ""
      - name: git-ref
        description: "Git ref from webhook (ref), e.g. refs/heads/main."
        value: ""
      - name: git-before
        description: "Previous commit SHA from webhook (before)."
        value: ""
      - name: git-after
        description: "New commit SHA from webhook (after)."
        value: ""

  # Exit handler for GitHub status notifications
  onExit: notify-github-exit

  templates:
    # Exit handler template for GitHub notifications
    # Passes workflow.status as arguments to avoid early validation at submission time
    # workflow.status is only available at exit time, not at submission time
    - name: notify-github-exit
      steps:
      - - name: send-notification
          template: send-github-status
          arguments:
            parameters:
            - name: phase
              value: "{{`{{ index workflow.labels \"workflows.argoproj.io/phase\" | lower | default \"unknown\" }}`}}"
            - name: workflow-name
              value: "{{`{{workflow.name}}`}}"
            - name: namespace
              value: "{{`{{workflow.namespace}}`}}"
            - name: labels
              value: "{{`{{workflow.labels}}`}}"
            - name: annotations
              value: "{{`{{workflow.annotations}}`}}"
            - name: status
              value: "{{`{{workflow.status}}`}}"
            - name: installation-id
              value: "{{`{{workflow.parameters.installation-id}}`}}"
            - name: commit-sha
              value: "{{`{{workflow.parameters.commit-sha}}`}}"

    
    # HTTP template for sending GitHub status notification
    # Receives workflow data as inputs to avoid validation errors at submission time
    - name: send-github-status
      inputs:
        parameters:
        - name: phase
        - name: workflow-name
        - name: namespace
        - name: labels
        - name: annotations
        - name: status
        - name: installation-id
        - name: commit-sha

      http:
        url: http://github-status-proxy.{{ $.Values.githubStatusProxy.namespace | default $.Values.namespaces.argocd }}.svc.cluster.local:8080/workflow
        method: POST
        headers:
          - name: Content-Type
            value: "application/json"
        body: |
          {
            "kind": "workflow",
            "event": "workflow-{{`{{inputs.parameters.phase}}`}}",
            "workflowName": "{{`{{inputs.parameters.workflow-name}}`}}",
            "namespace": "{{`{{inputs.parameters.namespace}}`}}",
            "installationId": "{{`{{inputs.parameters.installation-id}}`}}",
            "commitSha": "{{`{{inputs.parameters.commit-sha}}`}}",
            "phase": "{{`{{inputs.parameters.phase}}`}}",
            "labels": {{`{{inputs.parameters.labels}}`}},
            "annotations": {{`{{inputs.parameters.annotations}}`}},
            "status": "{{`{{inputs.parameters.status}}`}}",
            "target_url": "{{ $.Values.workflows.baseUrl }}/workflows/{{`{{inputs.parameters.namespace}}`}}/{{`{{inputs.parameters.workflow-name}}`}}"
          }

    - name: run-nextflow
      metadata:
        labels:
          calypr.io/commit-sha: "{{`{{workflow.parameters.commit-sha}}`}}"
          calypr.io/git-before: "{{`{{workflow.parameters.git-before}}`}}"
          calypr.io/git-after: "{{`{{workflow.parameters.git-after}}`}}"
          calypr.io/github-installation-id: "{{`{{workflow.parameters.installation-id}}`}}"
          calypr.io/repo: {{ $repoName }}
        annotations:
          calypr.io/repo-url: {{ $reg.repoUrl | quote }}
          workflows.argoproj.io/description: |
            Run a Nextflow pipeline from a Git repo using S3-backed
            work and artifact storage derived from RepoRegistration.
          workflows.argoproj.io/notifications: "enabled"
      container:
        image: nextflow-runner:latest
        imagePullPolicy: IfNotPresent
        workingDir: "{{ "{{workflow.parameters.work-dir}}" }}"
        command: ["/bin/bash", "-c"]
        args:
          - |
            set -euo pipefail
            
            cat <<'EOF'
            Workflow parameters: {{ "{{workflow.parameters}}" }}
            EOF
            
            echo "Cloning repo: {{ "{{workflow.parameters.repo-url}}" }}"
            git clone {{ "{{workflow.parameters.repo-url}}" }} repo

            cd repo
            # Prefer an explicit commit SHA (git-after) if provided, otherwise git-ref, otherwise revision
            if [ -n "{{ "{{workflow.parameters.commit-sha}}" }}" ]; then
              echo "Checking out commit SHA: {{ "{{workflow.parameters.commit-sha}}" }}"
              git checkout "{{ "{{workflow.parameters.commit-sha}}" }}"
            elif [ -n "{{ "{{workflow.parameters.git-ref}}" }}" ]; then
              echo "Checking out git ref: {{ "{{workflow.parameters.git-ref}}" }}"
              git checkout "{{ "{{workflow.parameters.git-ref}}" }}"
            else
              echo "Checking out revision: {{ "{{workflow.parameters.revision}}" }}"
              git checkout "{{ "{{workflow.parameters.revision}}" }}"
            fi

            echo "Artifact bucket: {{ "{{workflow.parameters.artifact-bucket}}" }}"

            env

            echo "Running Nextflow pipeline..."
            nextflow run {{ "{{workflow.parameters.pipeline-file}}" }} -with-report report.html -with-trace -with-timeline timeline.html

        env:
          - name: NXF_HOME
            value: /workspace/.nextflow
          - name: AWS_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: s3-credentials-{{ $repoName }}
                key: AWS_ACCESS_KEY_ID
          - name: AWS_SECRET_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: s3-credentials-{{ $repoName }}
                key: AWS_SECRET_ACCESS_KEY
          - name: AWS_REGION
            value: "{{ "{{workflow.parameters.artifact-region}}" }}"
          - name: AWS_S3_ENDPOINT
            value: "https://{{ "{{workflow.parameters.artifact-endpoint}}" }}"            
{{- end }}
{{- end }}

