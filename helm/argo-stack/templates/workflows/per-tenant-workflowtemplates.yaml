{{- /*
Per-Tenant Workflow Templates
Renders a WorkflowTemplate for each repoRegistration in its dedicated tenant namespace.
This ensures workflows can reference templates within the same namespace.
*/ -}}
{{- if .Values.repoRegistrations }}
{{- range $reg := .Values.repoRegistrations }}
{{- $namespace := include "argo-stack.repoRegistration.namespace" $reg }}
{{- $repoName := $reg.name }}
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: nextflow-repo-runner
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/name: argo-stack
    app.kubernetes.io/part-of: argo-workflows
    calypr.io/workflow-tenant: "true"
    calypr.io/repo: {{ $repoName }}
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "15"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  entrypoint: run-nextflow
  arguments:
    parameters:
      - name: repo-name
        description: "Repository name or identifier for accessing repo-specific secrets."
        value: {{ $repoName | quote }}
      - name: repo-url
        description: "Git repo containing the Nextflow pipeline."
        value: {{ $reg.repoUrl | quote }}
      - name: revision
        description: "Git revision (branch, tag, or SHA) to run."
        value: {{ $reg.defaultBranch | default "main" | quote }}
      - name: pipeline-file
        description: "Nextflow pipeline entry point file (e.g., main.nf, workflow.nf, pipeline.nf)."
        value: "main.nf"
      - name: work-dir
        description: "Work directory inside the container."
        value: "/workspace"
      - name: artifact-bucket
        description: "Artifact bucket name (from RepoRegistration.spec.artifactBucket.bucket)."
        {{- if $reg.artifactBucket }}
        value: {{ $reg.artifactBucket.bucket | quote }}
        {{- end }}
      - name: artifact-endpoint
        description: "Artifact S3 endpoint hostname/URL."
        {{- if $reg.artifactBucket }}
        value: {{ $reg.artifactBucket.hostname | quote }}
        {{- end }}
      - name: artifact-region
        description: "Artifact S3 region."
        {{- if $reg.artifactBucket }}
        value: {{ $reg.artifactBucket.region | quote }}
        {{- end }}

  templates:
    - name: run-nextflow
      metadata:
        annotations:
          workflows.argoproj.io/description: |
            Run a Nextflow pipeline from a Git repo using S3-backed
            work and artifact storage derived from RepoRegistration.
      container:
        image: nextflow/nextflow:{{ if $.Values.nextflow }}{{ $.Values.nextflow.version }}{{ else }}23.10.1{{ end }}
        workingDir: "{{ "{{workflow.parameters.work-dir}}" }}"
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -euo pipefail
            echo "Installing git..."
            apk add --no-cache git
            echo "Cloning repo: {{ "{{workflow.parameters.repo-url}}" }}"
            git clone {{ "{{workflow.parameters.repo-url}}" }} repo
            cd repo
            git checkout {{ "{{workflow.parameters.revision}}" }}

            echo "Configuring S3 environment for artifacts..."
            echo "Artifact bucket: {{ "{{workflow.parameters.artifact-bucket}}" }}"

            # Configure Nextflow to use S3 work directory
            export NXF_WORK="s3://{{ "{{workflow.parameters.artifact-bucket}}" }}/work"
            export NXF_S3_ENDPOINT="{{ "{{workflow.parameters.artifact-endpoint}}" }}"
            export NXF_S3_REGION="{{ "{{workflow.parameters.artifact-region}}" }}"

            echo "Running Nextflow pipeline..."
            nextflow run {{ "{{workflow.parameters.pipeline-file}}" }} -with-report report.html -with-trace -with-timeline timeline.html

        env:
          - name: NXF_HOME
            value: /workspace/.nextflow
          - name: AWS_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: s3-cred-{{ $repoName }}
                key: AWS_ACCESS_KEY_ID
          - name: AWS_SECRET_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: s3-cred-{{ $repoName }}
                key: AWS_SECRET_ACCESS_KEY
{{- end }}
{{- end }}
