apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: nextflow-repo-runner
  namespace: argo-workflows
  labels:
    app.kubernetes.io/name: argo-stack
spec:
  entrypoint: run-nextflow
  arguments:
    parameters:
      - name: repo-name
        description: "Repository name or identifier for accessing repo-specific secrets."
      - name: repo-url
        description: "Git repo containing the Nextflow pipeline."
      - name: revision
        description: "Git revision (branch, tag, or SHA) to run."
        value: "main"
      - name: pipeline-file
        description: "Nextflow pipeline entry point file (e.g., main.nf, workflow.nf, pipeline.nf)."
        value: "main.nf"
      - name: work-dir
        description: "Work directory inside the container."
        value: "/workspace"
      - name: artifact-bucket
        description: "Artifact bucket name (from RepoRegistration.spec.artifactBucket.bucket)."
      - name: artifact-endpoint
        description: "Artifact S3 endpoint hostname/URL."
      - name: artifact-region
        description: "Artifact S3 region."

  templates:
    - name: run-nextflow
      metadata:
        annotations:
          workflows.argoproj.io/description: |
            Run a Nextflow pipeline from a Git repo using S3-backed
            work and artifact storage derived from RepoRegistration.
      container:
        image: nextflow/nextflow:{{ .Values.nextflow.version }}
        workingDir: "{{workflow.parameters.work-dir}}"
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -euo pipefail
            echo "Cloning repo: {{workflow.parameters.repo-url}}"
            git clone {{workflow.parameters.repo-url}} repo
            cd repo
            git checkout {{workflow.parameters.revision}}

            echo "Configuring S3 environment for artifacts..."
            echo "Artifact bucket: {{workflow.parameters.artifact-bucket}}"

            # AWS credentials from s3-credentials Secret
            export AWS_ACCESS_KEY_ID="$(cat /secrets/s3/AWS_ACCESS_KEY_ID)"
            export AWS_SECRET_ACCESS_KEY="$(cat /secrets/s3/AWS_SECRET_ACCESS_KEY)"

            # Configure Nextflow to use S3 work directory
            export NXF_WORK="s3://{{workflow.parameters.artifact-bucket}}/work"
            export NXF_S3_ENDPOINT="{{workflow.parameters.artifact-endpoint}}"
            export NXF_S3_REGION="{{workflow.parameters.artifact-region}}"

            echo "Running Nextflow pipeline..."
            nextflow run {{workflow.parameters.pipeline-file}} -with-report report.html -with-trace -with-timeline timeline.html

        env:
          - name: NXF_HOME
            value: /workspace/.nextflow
        volumeMounts:
          - name: s3-credentials
            mountPath: /secrets/s3
            readOnly: true

      volumes:
        - name: s3-credentials
          secret:
            secretName: s3-cred-{{workflow.parameters.repo-name}}
            optional: false
