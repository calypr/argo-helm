# Default values for argo-stack chart
# Declare variables to be passed into your templates.

# ============================================================================
# Global namespace definitions
# ============================================================================

namespaces:
  argo: argo-workflows
  argocd: argocd
  calypr-tenants: calypr-tenants
  security: security
  argo-events: argo-events
  argo-stack: argo-stack
  calypr-api: calypr-api

# ============================================================================
# External Secrets Operator (ESO) and Vault Integration
# ============================================================================

externalSecrets:
  # Enable External Secrets integration
  enabled: true
  
  # Install External Secrets Operator as a dependency
  # Set to false if ESO is already installed cluster-wide
  installOperator: false
  
  # External Secrets Operator configuration (when installOperator=true)
  # These values are passed to the external-secrets subchart
  external-secrets:
    installCRDs: true
    # Namespace where ESO will be installed
    # Note: Leave empty to use the release namespace
    namespaceOverride: ""
    # Additional operator configuration can be added here
    # See: https://github.com/external-secrets/external-secrets/tree/main/deploy/charts/external-secrets
  
  # HashiCorp Vault provider configuration
  vault:
    enabled: true
    # Vault server address (required when vault.enabled=true)
    address: "http://vault.vault.svc.cluster.local:8200"
    
    # Optional: CA bundle for TLS verification
    # Reference to a Secret containing the CA certificate
    caBundleSecretName: ""
    caBundleSecretKey: "ca.crt"
    
    # Vault authentication configuration
    auth:
      # Auth method: kubernetes, jwt, or approle
      method: "kubernetes"
      
      # Path where the auth method is mounted in Vault
      mount: "kubernetes"
      
      # Vault role name for authentication
      role: "argo-stack"
      
      # ServiceAccount used by SecretStore for Kubernetes auth
      # This SA must have permissions to authenticate with Vault
      serviceAccountName: "eso-vault-auth"
      
      # AppRole configuration (when method=approle)
      approle:
        roleId: ""
        # Secret reference for AppRole secret ID
        secretRef:
          name: "vault-approle-secret"
          key: "secretId"
    
    # KV secrets engine configuration
    kv:
      # KV engine version (1 or 2)
      engineVersion: "v2"
      
      # Default path prefix for all secrets
      # Individual secret paths are relative to this prefix
      defaultPathPrefix: "kv"
    
    # SecretStore scope
    # Use "namespaced" for SecretStore (namespace-scoped)
    # Use "cluster" for ClusterSecretStore (cluster-wide)
    scope: "cluster"
    
    # Namespace for SecretStore (ignored when scope=cluster)
    namespace: "argocd"
  
  # Secret path mappings
  # Format: "path#key" where path is relative to vault.kv.defaultPathPrefix
  secrets:
    # Argo CD secrets
    argocd:
      # Admin password for initial login
      adminPasswordPath: "argo/argocd/admin#password"
      # Bcrypt hash of admin password (for argocd-secret)
      adminPasswordBcryptPath: "argo/argocd/admin#bcryptHash"
      # OIDC client secret
      ssoClientSecretPath: "argo/argocd/oidc#clientSecret"
      # Server secret key (for session signing)
      serverSecretKeyPath: "argo/argocd/server#secretKey"
    
    # Argo Workflows secrets
    workflows:
      # S3/artifact repository credentials
      artifactAccessKeyPath: "argo/workflows/artifacts"
      artifactSecretKeyPath: "argo/workflows/artifacts"
      # OIDC client secret
      ssoClientSecretPath: "argo/workflows/oidc/clientSecret"
    
    # Authorization adapter secrets
    authzAdapter:
      # OIDC client secret
      oidcClientSecretPath: "authz#clientSecret"
    
    # GitHub Events secrets
    github:
      # GitHub personal access token or webhook secret
      tokenPath: "argo/events/github"
    
    # Per-application S3 credentials
    # These are used when applications define custom artifact storage
    # Format: appName -> { accessKeyPath, secretKeyPath }
    perAppS3: {}
      # Example:
      # nextflow-hello:
      #   accessKeyPath: "apps/nextflow-hello/s3#accessKey"
      #   secretKeyPath: "apps/nextflow-hello/s3#secretKey"
      # nextflow-hello-2:
      #   accessKeyPath: "apps/nextflow-hello-2/s3#accessKey"
      #   secretKeyPath: "apps/nextflow-hello-2/s3#secretKey"

# ============================================================================
# Argo Workflows and Argo CD settings
# ============================================================================

# Argo Workflows dependency values
argo-workflows:
  server:
    enabled: true
    secure: false
    namespaced: true
    extraArgs:
      - --auth-mode=server
    # UI/API lives under /workflows
    baseHref: "/workflows/"
  controller:
    workflowNamespaces:
      - argo-workflows
    # Ensure controller uses correct namespace
    namespaceInstallMode: true
    # Enable log archiving for all workflows
    workflowDefaults:
      spec:
        archiveLogs: true
  # Force namespace for all Argo Workflows components
  namespaceOverride: argo-workflows

# Argo CD dependency values
argo-cd:
  applications:
    enabled: true
    namespace: argocd                       # where Argo CD runs
  namespaceOverride: argocd
  admin.enabled: "false"                    # turn off login screen
  configs:
    secret:
      create: true
      # provide a strong random key (hex or base64 is fine)
      extra: # MUST be a map, not a string/boolean
        # any sufficiently random string; 32+ chars is nice
        server.secretkey: "some-long-random-string-change-me"
      # Never commit your real token in a Git repo. instead, override it at deploy time using:
      # export ARGO_CD_SECRET=replace with output of: openssl rand -hex 32
      # helm upgrade --install ... argo-cd.configs.secret.extra."server\.secretkey"="${ARGOCD_SECRET_KEY}"
      # server.secretkey: "<?= replace with output of: openssl rand -hex 32 ?>"
    cm:
      # External URL including the sub-path
      url: https://calypr-demo.ddns.net/applications
      dex.config: |
        enablePasswordDB: false
        oauth2:
          alwaysShowLoginScreen: false
        connectors:
          - type: authproxy
            id: authproxy
            name: Auth Proxy
            config:
              userHeader: "X-Auth-Request-User"
              groupHeader: "X-Auth-Request-Groups"      
    params:
      # Argo CD is behind ingress that terminates TLS
      server.insecure: true
      # Tell ArgoCD UI/API it’s under /applications
      server.basehref: "/applications"
      # server.rootpath: "/applications"
  notifications:
    enabled: true

# ============================================================================
# Authorization Adapter Settings (Arborist Integration)
# ============================================================================

authzAdapter:
  image:
    repository: authz-adapter
    pullPolicy: IfNotPresent
    tag: v0.0.1
  fenceBase: "https://calypr-dev.ohsu.edu/user"
  replicas: 2
  # Ensure adapter uses security namespace
  namespace: security
  # Debug mode settings (for development/testing only)
  # When debugEmail is set, enables debug mode and allows debug_email/debug_groups query params
  debugEmail: brian@bwalsh.com
  # Comma-separated list of groups to assign to the debug user
  debugGroups: wf-admins

# ============================================================================
# Landing Page Configuration
# ============================================================================
# A simple static landing page that renders markdown files at the root path (/)
# Content is sourced from a host-mounted directory containing markdown files.

landingPage:
  # Enable the landing page deployment
  enabled: true
  # Container image configuration
  image:
    repository: landing-page
    tag: v3
    pullPolicy: IfNotPresent
  # Page title
  title: "Welcome"
  # --------------------------------------------------------------------------
  # docsPath - Host path to mount for markdown content (optional)
  # --------------------------------------------------------------------------
  # This is a Kubernetes hostPath volume that mounts a directory from the
  # node's filesystem into the landing-page container at /docs.
  #
  # For kind clusters:
  #   - The path refers to a directory inside the kind-control-plane container
  #   - To mount a host directory, use kind's extraMounts in kind-config.yaml:
  #       extraMounts:
  #         - hostPath: /path/on/your/host
  #           containerPath: /var/www/docs
  #   - Then set docsPath: "/var/www/docs"
  #
  # Content updates:
  #   - Changes to markdown files are picked up on browser refresh (no restart needed)
  #   - The page fetches markdown via JavaScript on each page load
  #   - nginx serves files directly from the mounted directory
  #
  # If not set, shows a default "no content available" message.
  # SECURITY: Only expose a dedicated docs directory, not sensitive host paths
  # Example: "/var/www/docs"
  docsPath: "/var/www/docs"

# ============================================================================
# GitHub App Callback Service Configuration
# ============================================================================
# Handles GitHub App post-installation callbacks and provides a web form
# for users to configure repository registration settings.

gitappCallback:
  # Enable the GitHub App callback service deployment
  enabled: true
  # Container image configuration
  image:
    repository: gitapp-callback
    tag: v1.0.0
    pullPolicy: IfNotPresent
  # Number of replicas
  replicas: 2
  # Flask secret key for session management
  # IMPORTANT: Change this in production
  secretKey: "change-me-in-production-use-vault"
  # GitHub App name (displayed in the UI)
  githubAppName: "calypr-workflows"

# ============================================================================
# Artifact Storage Configuration ( Results of Workflows )
# ============================================================================

s3:
  enabled: false
  hostname: ""
  bucket: ""
  region: ""
  insecure: false
  pathStyle: true
  accessKey: ""
  secretKey: ""


# NGINX auth to the adapter
ingressAuth:
  enabled: true
  authURL: "http://authz-adapter.security.svc.cluster.local:8080/check"
  passAuthorization: true

# ============================================================================
# Ingress Configuration
# ============================================================================

ingress:
  # Argo Workflows ingress
  argoWorkflows:
    enabled: false
    host: ""
    tls:
      enabled: false
      secretName: ""
  
  # Argo CD ingress
  argocd:
    enabled: false
    host: ""
    tls:
      enabled: false
      secretName: ""
  
  # GitHub App Callback ingress
  gitappCallback:
    enabled: false
    host: ""
    tls:
      enabled: false
      secretName: ""

# ============================================================================
# Ingress AuthZ Overlay - Unified Path-Based Routing with Centralized Auth
# ============================================================================
# Enable this overlay to provide a single host, path-based ingress for all
# major UIs and APIs, protected by the authz-adapter.
# See: helm/argo-stack/overlays/ingress-authz-overlay/docs/authz-ingress-user-guide.md
#
# To use the overlay, install it separately:
#   helm upgrade --install ingress-authz-overlay \
#     helm/argo-stack/overlays/ingress-authz-overlay \
#     --values helm/argo-stack/values.yaml \
#     --set ingressAuthzOverlay.enabled=true

ingressAuthzOverlay:
  enabled: true
  host: calypr-demo.ddns.net
  tls:
    secretName: calypr-demo-tls
  authzAdapter:
    # Use centralized adapter from security namespace
    deploy: false
    serviceName: authz-adapter
    namespace: security
    port: 8080
    path: /check
    signinUrl: https://calypr-demo.ddns.net/tenants/login
    responseHeaders: X-User, X-Email, X-Groups
  routes:
    landing:
      namespace: security
      service: landing-page
      port: 80
      pathPrefix: /
    workflows:
      namespace: argo-stack
      service: argo-stack-argo-workflows-server
      port: 2746
      pathPrefix: /workflows
    applications:
      namespace: argo-stack
      service: argo-stack-argocd-server
      port: 8080
      pathPrefix: /applications
      # ArgoCD server uses HTTPS by default
      backendProtocol: HTTPS      
    registrations:
      namespace: argo-stack
      service: github-repo-registrations-eventsource-svc
      port: 12000
      pathPrefix: /registrations
    api:
      namespace: calypr-api
      service: calypr-api
      port: 3000
      pathPrefix: /api
    tenants:
      namespace: calypr-tenants
      service: calypr-tenants
      port: 3001
      pathPrefix: /tenants

# ============================================================================
# Argo CD Applications - Multi-Application Support (REMOVED)
# ============================================================================
# ⚠️ DEPRECATED: Legacy Application Configuration Pattern
# ============================================================================
# The 'applications' array pattern has been REMOVED.
# Please use the RepoRegistration pattern instead.
#
# See:
# - docs/DEPRECATION_NOTICE.md for migration guidance
# - docs/repo-registration-guide.md for the new pattern
# - examples/repo-registrations-values.yaml for examples
#
# The templates that used this configuration have been removed:
# - argocd/applications.yaml (removed)
# - workflows/per-app-workflowtemplates.yaml (removed)
# - 21-per-app-artifact-repositories.yaml (removed)
# - eso/externalsecret-per-app-s3.yaml (removed)
# - events/eventsource-github.yaml (removed)
#
# Migration path:
# Convert each application entry to a repoRegistrations entry below.
# ============================================================================

# ============================================================================
# Argo Events Configuration - GitHub EventSource and Sensor
# ============================================================================

events:
  enabled: true
  namespace: argo-events

  eventBus:
    create: true
    name: default
    # natsNative: {}  # use NATS native by default

  github:
    enabled: true
    name: github

    # ========================================================================
    # ⚠️ DEPRECATED: Legacy Repository Configuration Pattern (REMOVED)
    # ========================================================================
    # The 'repositories' array pattern has been REMOVED.
    # Please use the RepoRegistration pattern instead.
    #
    # See:
    # - docs/DEPRECATION_NOTICE.md for migration guidance
    # - docs/repo-registration-guide.md for the new pattern
    # - examples/repo-registrations-values.yaml for examples
    # ========================================================================

    # ========================================================================
    # Secret for GitHub API Token
    # ========================================================================

    secret:
      create: true                       # chart will render a Secret manifest
      name: github-secret                # name of the Secret object
      tokenKey: token                    # key inside the Secret
      # Never commit your real token in a Git repo. instead, override it at deploy time using:
      # export GITHUB_PAT=github_pat_XXXXXXXX
      # helm upgrade --install --set-string events.github.secret.tokenValue=$GITHUB_PAT


    # Webhook service exposed by EventSource
    webhook:
      endpoint: /events
      port: 12000
      # IMPORTANT: Set the webhook URL that GitHub will call when events occur.
      # This must be publicly accessible from GitHub. Example:
      #   --set-string events.github.webhook.url=http://your-domain.com:12000
      # Or use the ingress configuration below with a proper hostname.
      # url: ""  # Set this via --set-string at deployment time
      service:
        type: ClusterIP
      ingress:
        enabled: true
        className: nginx
        hosts: []  # Add your public hostname to create Ingress, e.g., ["webhooks.example.com"]
        tls: []

  # ========================================================================
  # Legacy sensor configuration has been removed.
  # Sensors are now automatically generated from repoRegistrations.
  # See templates/events/sensor-github-push.yaml
  # ========================================================================

# ============================================================================
# Workflow Execution Configuration
# ============================================================================
# The RepoRegistration pattern automatically creates per-tenant:
# - Namespaces (wf-<tenant>-<repo>)
# - ServiceAccounts (wf-runner)
# - RBAC roles and bindings
# - WorkflowTemplates (nextflow-repo-runner)
#
# Legacy static namespace configuration has been removed.
# See templates/11-tenant-rbac-from-repo-registrations.yaml for details.

workflows:
  # ServiceAccount name used by workflow pods in tenant namespaces
  # This is created automatically per tenant by repoRegistrations
  runnerServiceAccount: wf-runner

# ============================================================================
# RepoRegistration - Self-Service Repository Onboarding (DECLARATIVE)
# ============================================================================
# Alternative to manually defining applications and events.github.repositories.
# Use this array to define repositories using the RepoRegistration model.
# The chart will automatically generate:
# - ArgoCD Applications
# - Argo Events GitHub EventSources
# - ExternalSecrets for S3 and GitHub credentials
# - Artifact Repository ConfigMaps
#
# Each entry follows the RepoRegistration CRD schema.
# See docs/repo-registration-guide.md for complete documentation.
#
# Example:
# repoRegistrations:
#   - name: my-nextflow-project
#     repoUrl: https://github.com/myorg/my-nextflow-project.git
#     defaultBranch: main
#     tenant: myorg
#     # namespace is auto-generated as wf-<tenant>-<repo-name>
#     workflowTemplateRef: nextflow-repo-runner
#     artifactBucket:
#       hostname: https://s3.us-west-2.amazonaws.com
#       bucket: my-project-artifacts
#       region: us-west-2
#       insecure: false
#       pathStyle: false
#       externalSecretPath: argo/apps/my-nextflow-project/s3/artifacts
#     dataBucket:
#       hostname: https://s3.us-west-2.amazonaws.com
#       bucket: my-project-data
#       region: us-west-2
#       externalSecretPath: argo/apps/my-nextflow-project/s3/data
#     githubSecretName: github-secret-my-project
#     githubSecretPath: argo/apps/my-nextflow-project/github
#     adminUsers:
#       - admin@myorg.com
#     readUsers:
#       - viewer@myorg.com
#     isPublic: false
#
# See examples/repo-registrations-example.yaml for more examples

repoRegistrations: []
  # Example configurations (provide your own at deployment time):
  #
  # - name: nextflow-hello-project
  #   repoUrl: https://github.com/YOUR_ORG/nextflow-hello-project.git
  #   defaultBranch: main
  #   tenant: myorg
  #   # namespace is auto-generated as wf-<tenant>-<repo-name>
  #   workflowTemplateRef: nextflow-repo-runner
  #   artifactBucket:
  #     hostname: https://s3.us-west-2.amazonaws.com
  #     bucket: myorg-nextflow-artifacts
  #     region: us-west-2
  #     externalSecretPath: argo/apps/nextflow-hello-project/s3/artifacts
  #   githubSecretName: github-secret-nextflow-hello
  #   githubSecretPath: argo/apps/nextflow-hello-project/github
  #   adminUsers:
  #     - admin@myorg.com
  #
  # See examples/repo-registrations-example.yaml and docs/repo-registration-guide.md


# for roles
# Namespace where Argo CD is installed
argocdNamespace: argocd

# Prefix for workflow namespaces. For a repoUrl https://github.com/<org>/<repo>.git,
# the workflow namespace is assumed to be: <workflowNamespacePrefix><org>-<repo>
workflowNamespacePrefix: wf-

# Global group that should have full Argo CD admin privileges
adminGroup: wf-admins


# ============================================================================
# GitHub App Authentication for Repository Access
# ============================================================================
# Use GitHub App for secure, auditable, least-privilege repository access.
# This replaces Personal Access Tokens (PATs) or SSH keys with short-lived
# installation tokens that are automatically rotated.
#
# See docs/github-app-setup.md for detailed setup instructions.

githubApp:
  # Enable GitHub App authentication for Argo CD repositories
  enabled: true

  # GitHub App ID (found in the GitHub App settings)
  appId: $GITHUBHAPP_APP_ID

  # GitHub App Installation ID (found in the installation settings)
  installationId: $GITHUBHAPP_INSTALLATION_ID

  # Name of the Kubernetes Secret containing the GitHub App private key
  # The secret should contain a key named 'privateKey' with the PEM-formatted key
  privateKeySecretName: $GITHUBHAPP_PRIVATE_KEY_SECRET_NAME

  # Vault path for the GitHub App private key (when using External Secrets)
  # Format: "path#key" where path is relative to vault.kv.defaultPathPrefix
  privateKeyVaultPath: $GITHUBHAPP_PRIVATE_KEY_VAULT_PATH

  # Repository credential scope
  # Use this to grant access to all repositories under an organization
  # Example: "https://github.com/your-org" grants access to all repos in the org
  # repoCredsUrl: ""

  # Additional annotations for the repo-creds secret
  annotations: {}

# ============================================================================
# Argo CD Notifications - GitHub Status Integration
# ============================================================================
# Configure Argo CD to post deployment status updates back to GitHub.
# This enables developers to see sync status directly in pull requests
# and commit statuses without switching to the Argo CD UI.
#
# See docs/github-app-setup.md for GitHub App permissions setup.

notifications:
  # Enable Argo CD Notifications controller
  enabled: true
  # for status templates
  argocdUrl: https://calypr-demo.ddns.net/applications
  # turn on debugging
  # https://github.com/argoproj/argo-helm/blob/main/charts/argo-cd/templates/argocd-notifications/deployment.yaml#L76-L77
  logLevel: debug
  # https://github.com/argoproj/argo-helm/blob/main/charts/argo-cd/templates/argocd-notifications/deployment.yaml#L86-L88
  extraEnv:
    - name: ARGOCD_NOTIFICATIONS_HTTP_DEBUG
      value: "true"
    - name: GODEBUG
      value: "http2debug=2"
  # GitHub notification service configuration
  github:
    # Enable GitHub status updates
    enabled: true

    # Use GitHub App for notifications (recommended)
    # When enabled, uses the same GitHub App as repository authentication
    useGithubApp: true

    # GitHub App ID (defaults to githubApp.appId if not set)
    # appId: ""

    # GitHub App Installation ID (defaults to githubApp.installationId if not set)
    # installationId: ""

    # Private key secret reference (defaults to githubApp.privateKeySecretName if not set)
    # privateKeySecretName: ""

  # Default notification triggers
  # These define when notifications are sent
  triggers:
    # Notify on successful sync
    onSyncSucceeded: true
    # Notify on failed sync
    onSyncFailed: true
    # Notify when sync is running
    onSyncRunning: false
    # Notify on health degraded
    onHealthDegraded: false

  # Application annotations to subscribe to notifications
  # Add these annotations to your Argo CD Applications to enable notifications:
  #   notifications.argoproj.io/subscribe.on-sync-succeeded.github: ""
  #   notifications.argoproj.io/subscribe.on-sync-failed.github: ""
  defaultSubscriptions:
    # Automatically add notification subscriptions to applications
    # created from repoRegistrations
    autoSubscribe: true

