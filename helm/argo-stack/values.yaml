# Default values for argo-stack chart
# Declare variables to be passed into your templates.

# ============================================================================
# Global namespace definitions
# ============================================================================

namespaces:
  argo: argo-workflows
  argocd: argocd
  tenant: wf-poc
  security: security
  argo-events: argo-events

# ============================================================================
# External Secrets Operator (ESO) and Vault Integration
# ============================================================================

externalSecrets:
  # Enable External Secrets integration
  enabled: false
  
  # Install External Secrets Operator as a dependency
  # Set to false if ESO is already installed cluster-wide
  installOperator: false
  
  # External Secrets Operator configuration (when installOperator=true)
  # These values are passed to the external-secrets subchart
  external-secrets:
    installCRDs: true
    # Namespace where ESO will be installed
    # Note: Leave empty to use the release namespace
    namespaceOverride: ""
    # Additional operator configuration can be added here
    # See: https://github.com/external-secrets/external-secrets/tree/main/deploy/charts/external-secrets
  
  # HashiCorp Vault provider configuration
  vault:
    enabled: true
    # Vault server address (required when vault.enabled=true)
    address: "http://vault.vault.svc.cluster.local:8200"
    
    # Optional: CA bundle for TLS verification
    # Reference to a Secret containing the CA certificate
    caBundleSecretName: ""
    caBundleSecretKey: "ca.crt"
    
    # Vault authentication configuration
    auth:
      # Auth method: kubernetes, jwt, or approle
      method: "kubernetes"
      
      # Path where the auth method is mounted in Vault
      mount: "kubernetes"
      
      # Vault role name for authentication
      role: "argo-stack"
      
      # ServiceAccount used by SecretStore for Kubernetes auth
      # This SA must have permissions to authenticate with Vault
      serviceAccountName: "eso-vault-auth"
      
      # AppRole configuration (when method=approle)
      approle:
        roleId: ""
        # Secret reference for AppRole secret ID
        secretRef:
          name: "vault-approle-secret"
          key: "secretId"
    
    # KV secrets engine configuration
    kv:
      # KV engine version (1 or 2)
      engineVersion: 2
      
      # Default path prefix for all secrets
      # Individual secret paths are relative to this prefix
      defaultPathPrefix: "kv/argo"
    
    # SecretStore scope
    # Use "namespaced" for SecretStore (namespace-scoped)
    # Use "cluster" for ClusterSecretStore (cluster-wide)
    scope: "namespaced"
    
    # Namespace for SecretStore (ignored when scope=cluster)
    namespace: "argocd"
  
  # Secret path mappings
  # Format: "path#key" where path is relative to vault.kv.defaultPathPrefix
  secrets:
    # Argo CD secrets
    argocd:
      # Admin password for initial login
      adminPasswordPath: "argocd/admin#password"
      # Bcrypt hash of admin password (for argocd-secret)
      adminPasswordBcryptPath: "argocd/admin#bcryptHash"
      # OIDC client secret
      ssoClientSecretPath: "argocd/oidc#clientSecret"
      # Server secret key (for session signing)
      serverSecretKeyPath: "argocd/server#secretKey"
    
    # Argo Workflows secrets
    workflows:
      # S3/artifact repository credentials
      artifactAccessKeyPath: "workflows/artifacts#accessKey"
      artifactSecretKeyPath: "workflows/artifacts#secretKey"
      # OIDC client secret
      ssoClientSecretPath: "workflows/oidc#clientSecret"
    
    # Authorization adapter secrets
    authzAdapter:
      # OIDC client secret
      oidcClientSecretPath: "authz#clientSecret"
    
    # GitHub Events secrets
    github:
      # GitHub personal access token or webhook secret
      tokenPath: "events/github#token"
    
    # Per-application S3 credentials
    # These are used when applications define custom artifact storage
    # Format: appName -> { accessKeyPath, secretKeyPath }
    perAppS3: {}
      # Example:
      # nextflow-hello:
      #   accessKeyPath: "apps/nextflow-hello/s3#accessKey"
      #   secretKeyPath: "apps/nextflow-hello/s3#secretKey"
      # nextflow-hello-2:
      #   accessKeyPath: "apps/nextflow-hello-2/s3#accessKey"
      #   secretKeyPath: "apps/nextflow-hello-2/s3#secretKey"

# ============================================================================
# Argo Workflows and Argo CD settings
# ============================================================================

# Argo Workflows dependency values
argo-workflows:
  server:
    enabled: true
    secure: false
    namespaced: true
    extraArgs:
      - --auth-mode=server
  controller:
    workflowNamespaces:
      - wf-poc
    # Ensure controller uses correct namespace
    namespaceInstallMode: true
    # Enable log archiving for all workflows
    workflowDefaults:
      spec:
        archiveLogs: true
  # Force namespace for all Argo Workflows components
  namespaceOverride: argo-workflows

# Argo CD dependency values
argo-cd:
  applications:
    enabled: true
    namespace: argocd                       # where Argo CD runs
  namespaceOverride: argocd
  configs:
    secret:
      create: true
      # provide a strong random key (hex or base64 is fine)
      extra: {}  # MUST be a map, not a string/boolean
      # Never commit your real token in a Git repo. instead, override it at deploy time using:
      # export ARGO_CD_SECRET=replace with output of: openssl rand -hex 32
      # helm upgrade --install ... argo-cd.configs.secret.extra."server\.secretkey"="${ARGOCD_SECRET_KEY}"
      # server.secretkey: "<?= replace with output of: openssl rand -hex 32 ?>"

# ============================================================================
# Authorization Adapter Settings (Arborist Integration)
# ============================================================================

authzAdapter:
  image: ghcr.io/calypr/argo-helm:latest
  fenceBase: "https://calypr-dev.ohsu.edu/user"
  replicas: 2
  # Ensure adapter uses security namespace
  namespace: security

# ============================================================================
# Artifact Storage Configuration ( Results of Workflows )
# ============================================================================

s3:
  enabled: false
  hostname: ""
  bucket: ""
  region: ""
  insecure: false
  pathStyle: true
  accessKey: ""
  secretKey: ""

# Ingresses we ship (toggle/hosts)
ingress:
  argoWorkflows:
    enabled: true
    host: "argo.localtest.me"
    tls:
      enabled: false
      secretName: ""
  argocd:
    enabled: true
    host: "argocd.localtest.me"
    tls:
      enabled: false
      secretName: ""

# NGINX auth to the adapter
ingressAuth:
  enabled: true
  authURL: "http://authz-adapter.security.svc.cluster.local:8080/check"
  passAuthorization: true

# ============================================================================
# Argo CD Applications - Multi-Application Support (RECOMMENDED)
# ============================================================================
# Use this array to deploy multiple Argo CD Applications.
# Each entry creates a separate Application resource.
#
# Per-Repository Artifact Configuration:
# Each application can have its own S3 bucket/prefix for workflow artifacts.
# This enables tenant isolation, data governance, and traceability.
#
# Example:
# applications:
#   - name: nextflow-hello-project
#     project: default
#     repoURL: https://github.com/bwalsh/nextflow-hello-project.git
#     targetRevision: main
#     path: "."
#     destination:
#       server: https://kubernetes.default.svc
#       namespace: argo
#     syncPolicy:
#       automated:
#         prune: true
#         selfHeal: true
#     artifacts:
#       bucket: calypr-nextflow-hello
#       keyPrefix: workflows/
#       endpoint: https://s3.us-west-2.amazonaws.com
#       region: us-west-2
#       insecure: false
#       credentialsSecret: s3-cred-nextflow-hello
#       # Optional: Use IRSA/Workload Identity instead of static credentials
#       # useSDKCreds: true
#
#   - name: nextflow-hello-project-2
#     project: default
#     repoURL: https://github.com/bwalsh/nextflow-hello-project-2.git
#     targetRevision: main
#     path: "."
#     destination:
#       namespace: argo
#     syncPolicy:
#       automated:
#         prune: true
#         selfHeal: true
#     artifacts:
#       bucket: calypr-nextflow-hello-2
#       keyPrefix: workflows/
#       endpoint: https://s3.us-west-2.amazonaws.com
#       region: us-west-2
#       credentialsSecret: s3-cred-nextflow-hello-2
#
# If no artifacts config is provided for an application, it will fall back
# to the global s3 configuration defined above.
#

applications:
  - name: nextflow-hello
    repoURL: https://github.com/bwalsh/nextflow-hello-project.git
    targetRevision: main
    path: "."
    destination:
      namespace: argo
    syncPolicy:
      automated:
        prune: true
        selfHeal: true
  - name: nextflow-hello-2
    repoURL: https://github.com/bwalsh/nextflow-hello-project-2.git
    targetRevision: main
    path: "."
    destination:
      namespace: argo
    syncPolicy:
      automated:
        prune: true
        selfHeal: true

# ============================================================================
# Argo Events Configuration - GitHub EventSource and Sensor
# ============================================================================

events:
  enabled: true
  namespace: argo-events

  eventBus:
    create: true
    name: default
    natsNative: {}  # use NATS native by default

  github:
    enabled: true
    name: github

    # ========================================================================
    # Multi-Repository Support (RECOMMENDED)
    # ========================================================================
    # Define multiple repositories in an array. Each repository gets its own
    # event name within the same EventSource.
    #
    # Example:
    repositories:
      - eventName: repo_push_nextflow_hello_project  # Must align with sensor event, must be unique
        owner: bwalsh
        repository: nextflow-hello-project
        events: ["push"]
        active: true
      - eventName: repo_push_nextflow_hello_project_2
        owner: bwalsh
        repository: nextflow-hello-project-2
        events: ["push"]
        active: true

    # ========================================================================
    # Secret for GitHub API Token
    # ========================================================================

    secret:
      create: true                       # chart will render a Secret manifest
      name: github-secret                # name of the Secret object
      tokenKey: token                    # key inside the Secret
      # Never commit your real token in a Git repo. instead, override it at deploy time using:
      # export GITHUB_PAT=github_pat_XXXXXXXX
      # helm upgrade --install --set-string events.github.secret.tokenValue=$GITHUB_PAT


    # Webhook service exposed by EventSource
    webhook:
      endpoint: /events
      port: 12000
      # IMPORTANT: Set the webhook URL that GitHub will call when events occur.
      # This must be publicly accessible from GitHub. Example:
      #   --set-string events.github.webhook.url=http://your-domain.com:12000
      # Or use the ingress configuration below with a proper hostname.
      # url: ""  # Set this via --set-string at deployment time
      service:
        type: ClusterIP
      ingress:
        enabled: true
        className: nginx
        hosts: []  # Add your public hostname to create Ingress, e.g., ["webhooks.example.com"]
        tls: []

  sensor:
    enabled: true
    name: run-nextflow-on-push
    workflowNamespace: wf-poc
    workflowTemplateRef: nextflow-hello-template
    parameters:
      - name: git_revision
        valueFrom: "{{(events.push.body.head_commit.id)}}"  # from GitHub payload

workflowTemplates:
  createExample: true
  namespace: wf-poc
  nextflowHello:
    name: nextflow-hello-template
    image: alpine:3.20
    command: ["/bin/sh", "-c"]
    args:
      - echo "Hello from Argo Events!"

workflows:
  namespace: wf-poc
  runnerServiceAccount: wf-runner
  templateRef: nextflow-hello-template
