apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: {{ .Values.argocdNamespace }}
data:
  policy.csv: |
    # Global Argo CD admin: full control over all resources
    p, role:wf-admin, *, *, *, allow
    g, {{ .Values.adminGroup }}, role:wf-admin

    # Per-repo roles derived from values.repoRegistrations
    {{- range $r := .Values.repoRegistrations }}
    {{- $repoUrl := required "repoRegistrations[].repoUrl is required" $r.repoUrl }}
    {{- $trimmed := $repoUrl | trimPrefix "https://github.com/" | trimSuffix ".git" }}
    {{- $parts := splitList "/" $trimmed }}
    {{- $org := index $parts 0 }}
    {{- $repo := index $parts 1 }}
    {{- $appName := printf "%s-%s" $org $repo }}
    {{- $projectName := $appName }}
    {{- $writerGroup := printf "wf-%s-%s-writers" $org $repo }}
    {{- $readerGroup := printf "wf-%s-%s-readers" $org $repo }}

    # Writer: manage this application's lifecycle within its project
    p, role:wf-{{ $org }}-{{ $repo }}-writer, applications, get, {{ $projectName }}/{{ $appName }}, allow
    p, role:wf-{{ $org }}-{{ $repo }}-writer, applications, sync, {{ $projectName }}/{{ $appName }}, allow
    p, role:wf-{{ $org }}-{{ $repo }}-writer, applications, action/*, {{ $projectName }}/{{ $appName }}, allow
    p, role:wf-{{ $org }}-{{ $repo }}-writer, projects, get, {{ $projectName }}, allow
    g, {{ $writerGroup }}, role:wf-{{ $org }}-{{ $repo }}-writer

    # Reader: view this application and its project, but no sync
    p, role:wf-{{ $org }}-{{ $repo }}-reader, applications, get, {{ $projectName }}/{{ $appName }}, allow
    p, role:wf-{{ $org }}-{{ $repo }}-reader, projects, get, {{ $projectName }}, allow
    g, {{ $readerGroup }}, role:wf-{{ $org }}-{{ $repo }}-reader

    {{- end }}

  policy.default: role:readonly
