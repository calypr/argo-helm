apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: reporegistrations.platform.calypr.io
spec:
  group: platform.calypr.io
  scope: Namespaced
  names:
    plural: reporegistrations
    singular: reporegistration
    kind: RepoRegistration
    shortNames:
      - rr
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: RepoRegistration defines self-service onboarding for Git repos.
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - repoUrl
                - tenant
                - workflowTemplateRef
                - githubSecretName
              properties:
                repoUrl:
                  type: string
                  description: "Git repository URL to onboard (https://github.com/org/repo.git)"
                  pattern: '^https://.+\.git$'
                defaultBranch:
                  type: string
                  description: "Default branch to track (e.g. main)"
                tenant:
                  type: string
                  description: "Tenant identifier, e.g. program/project or org short code."
                workflowTemplateRef:
                  type: string
                  description: "Argo WorkflowTemplate name used to run this repo's workflows."
                artifactBucket:
                  type: object
                  description: >
                    S3-compatible artifact bucket configuration. Credentials are discovered
                    via Vault using externalSecretPath and injected by External Secrets Operator.
                  properties:
                    hostname:
                      type: string
                      description: "S3 endpoint hostname or URL (e.g. https://minio.example.org:9000)"
                    bucket:
                      type: string
                      description: "Bucket name for storing workflow artifacts."
                    region:
                      type: string
                      description: "Object store region (AWS-compatible semantics)."
                    insecure:
                      type: boolean
                      description: "Use HTTP instead of HTTPS when connecting to the bucket."
                    pathStyle:
                      type: boolean
                      description: "If true, forces path-style requests (s3.amazonaws.com/bucket)."
                    externalSecretPath:
                      type: string
                      description: >
                        Vault KV v2 path holding S3 credentials for this artifact bucket
                        (e.g. argo/apps/my-repo/s3/artifacts).
                dataBucket:
                  type: object
                  description: >
                    S3-compatible data bucket configuration. Credentials are discovered
                    via Vault using externalSecretPath and injected by External Secrets Operator.
                  properties:
                    hostname:
                      type: string
                      description: "S3 endpoint hostname or URL (e.g. https://minio.example.org:9000)"
                    bucket:
                      type: string
                      description: "Bucket name for storing primary data."
                    region:
                      type: string
                      description: "Object store region (AWS-compatible semantics)."
                    insecure:
                      type: boolean
                      description: "Use HTTP instead of HTTPS when connecting to the bucket."
                    pathStyle:
                      type: boolean
                      description: "If true, forces path-style requests (s3.amazonaws.com/bucket)."
                    externalSecretPath:
                      type: string
                      description: >
                        Vault KV v2 path holding S3 credentials for this data bucket
                        (e.g. argo/apps/my-repo/s3/data).
                githubSecretName:
                  type: string
                  description: >
                    Name of the Kubernetes Secret or ExternalSecret target that contains
                    GitHub credentials (PAT or GitHub App token, webhook secret, etc.).
                adminUsers:
                  type: array
                  description: >
                    List of administrator user email addresses. These must correspond to
                    Fence-authenticated and Arborist-authorized identities with admin-level
                    access to workflows, logs, and configuration.
                  items:
                    type: string
                    format: email
                readUsers:
                  type: array
                  description: >
                    List of read-only user email addresses. These correspond to
                    Fence-authenticated, Arborist-authorized users with viewer access
                    to workflow logs, metadata, and outputs.
                  items:
                    type: string
                    format: email
                isPublic:
                  type: boolean
                  description: >
                    If true, Argo workflow UIs and metadata for this repo may be visible
                    without Fence login, depending on ingress and authorization policy.
            status:
              type: object
              description: Current reconciliation state of the RepoRegistration.
              properties:
                phase:
                  type: string
                  description: "Simple phase indicator (Pending, Ready, Error)."
                message:
                  type: string
                  description: "Human-readable status message for debugging."
                lastReconciled:
                  type: string
                  format: date-time
                  description: "Timestamp of last successful reconciliation."
