<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js" 
            integrity="sha384-XBk0FhF/qQ5cDV1gvlrYr9w4Q5pBPj8bMVQBxLRWMIxBKJfIYXvPYbYfIKRdTNBj" 
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"
            integrity="sha384-EUbMXEP9LRgvPlJPxn/Q+R4rKDZNR+K2kQv2dNbUSNVYH3C4LoqLI4JKnwrCUGJq"
            crossorigin="anonymous"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #24292e;
            --link-color: #0366d6;
            --code-bg: #f6f8fa;
            --border-color: #e1e4e8;
            --blockquote-border: #dfe2e5;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #0d1117;
                --text-color: #c9d1d9;
                --link-color: #58a6ff;
                --code-bg: #161b22;
                --border-color: #30363d;
                --blockquote-border: #3b434b;
            }
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .error-container {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .error-container h1 {
            color: #d73a49;
            margin-bottom: 1rem;
        }
        
        .error-container p {
            color: var(--text-color);
            opacity: 0.8;
        }
        
        #content {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Markdown styling */
        #content h1, #content h2, #content h3, 
        #content h4, #content h5, #content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
            line-height: 1.25;
        }
        
        #content h1 {
            font-size: 2em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
        }
        
        #content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
        }
        
        #content a {
            color: var(--link-color);
            text-decoration: none;
        }
        
        #content a:hover {
            text-decoration: underline;
        }
        
        #content code {
            background-color: var(--code-bg);
            padding: 0.2em 0.4em;
            border-radius: 6px;
            font-size: 85%;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        
        #content pre {
            background-color: var(--code-bg);
            padding: 16px;
            overflow: auto;
            border-radius: 6px;
            line-height: 1.45;
        }
        
        #content pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            font-size: 100%;
        }
        
        #content blockquote {
            margin: 0;
            padding: 0 1em;
            color: var(--text-color);
            opacity: 0.8;
            border-left: 0.25em solid var(--blockquote-border);
        }
        
        #content ul, #content ol {
            padding-left: 2em;
        }
        
        #content li {
            margin: 0.25em 0;
        }
        
        #content img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
        }
        
        #content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        
        #content th, #content td {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
        }
        
        #content th {
            background-color: var(--code-bg);
            font-weight: 600;
        }
        
        #content hr {
            border: 0;
            height: 1px;
            background-color: var(--border-color);
            margin: 2em 0;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-color);
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div id="content">
        <div class="loading">Loading content...</div>
    </div>

    <script>
        (function() {
            const contentDiv = document.getElementById('content');
            const contentPath = '{{ content_path }}';
            const baseUrl = '{{ base_url }}';
            const hasContent = {{ 'true' if has_content else 'false' }};
            const errorMessage = '{{ error_message }}';
            
            if (!hasContent) {
                contentDiv.innerHTML = DOMPurify.sanitize(`
                    <div class="error-container">
                        <h1>No Content Available</h1>
                        <p>${errorMessage || 'No markdown content found in the configured directory.'}</p>
                        <p>To add content, place an <code>index.md</code> or <code>README.md</code> file in the content directory.</p>
                    </div>
                `);
                return;
            }
            
            // Fetch and render markdown
            fetch(contentPath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load content');
                    }
                    return response.text();
                })
                .then(markdown => {
                    // Configure marked to handle relative URLs
                    const renderer = new marked.Renderer();
                    
                    // Handle relative image URLs
                    const originalImage = renderer.image.bind(renderer);
                    renderer.image = function(href, title, text) {
                        if (href && !href.startsWith('http://') && !href.startsWith('https://') && !href.startsWith('/')) {
                            href = baseUrl + '/' + href;
                        }
                        return originalImage(href, title, text);
                    };
                    
                    // Handle relative link URLs
                    const originalLink = renderer.link.bind(renderer);
                    renderer.link = function(href, title, text) {
                        if (href && !href.startsWith('http://') && !href.startsWith('https://') && !href.startsWith('/') && !href.startsWith('#')) {
                            href = baseUrl + '/' + href;
                        }
                        return originalLink(href, title, text);
                    };
                    
                    marked.setOptions({
                        renderer: renderer,
                        gfm: true,
                        breaks: false,
                        pedantic: false,
                        smartLists: true,
                        smartypants: false
                    });
                    
                    // Parse markdown and sanitize output to prevent XSS
                    const rawHtml = marked.parse(markdown);
                    contentDiv.innerHTML = DOMPurify.sanitize(rawHtml, {
                        ADD_TAGS: ['iframe'],
                        ADD_ATTR: ['allowfullscreen', 'frameborder', 'target']
                    });
                    
                    // Update page title from first h1 if present
                    const firstH1 = contentDiv.querySelector('h1');
                    if (firstH1) {
                        document.title = firstH1.textContent;
                    }
                })
                .catch(error => {
                    contentDiv.innerHTML = DOMPurify.sanitize(`
                        <div class="error-container">
                            <h1>Error Loading Content</h1>
                            <p>Unable to load the markdown content.</p>
                            <p><small>${error.message}</small></p>
                        </div>
                    `);
                });
        })();
    </script>
</body>
</html>
